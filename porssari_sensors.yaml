template:
  # Pörssäri price sensors
  - sensor:
      - name: porssari_price_now
        unit_of_measurement: "snt/kWh"
        device_class: monetary
        attributes:
          friendly_name: "Pörssäri sähkön hinta nyt"
        state: >
          {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
            {% set curHour = now().strftime('%Y-%m-%dT%H:00:00%z') | string %}
            {{ state_attr("sensor.porssari_json_data", "Prices")[curHour]['Price'] | float }}
          {% else %}
            {{ 0 }}
          {% endif %}
      - name: porssari_avg_today
        unit_of_measurement: "snt/kWh"
        device_class: monetary
        state: >
          {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
            {% set timeStampList = state_attr("sensor.porssari_json_data", "Prices") | list %}
            {% set ns = namespace(prices=[]) %}
            {% for item in timeStampList %}
              {% if now().day == as_datetime(item).day %}
                {% set ns.prices = ns.prices + [state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float] %}
              {% endif %}
            {% endfor %}
            {{ ns.prices | average | float | round(2) if ns.prices | length >= 23 else 0 }}
          {% else %}
            {{ 0 }}
          {% endif %}
      - name: porssari_avg_tomorrow
        unit_of_measurement: "snt/kWh"
        device_class: monetary
        state: >
          {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
            {% set timeStampList = state_attr("sensor.porssari_json_data", "Prices") | list %}
            {% set tomorrow = now() + timedelta( days = 1 ) %}
            {% set ns = namespace(prices=[]) %}
            {% for item in timeStampList %}
              {% if tomorrow.day == as_datetime(item).day %}
                {% set ns.prices = ns.prices + [state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float] %}
              {% endif %}
            {% endfor %}
            {{ ns.prices | average | float | round(2) if ns.prices | length >= 23 else 0 }}
          {% else %}
            {{ 0 }}
          {% endif %}
      - name: porssari_min_today
        unit_of_measurement: "snt/kWh"
        device_class: monetary
        state: >
          {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
            {% set timeStampList = state_attr("sensor.porssari_json_data", "Prices") | list %}
            {% set ns = namespace(prices=[]) %}
            {% for item in timeStampList %}
              {% if now().day == as_datetime(item).day %}
                {% set ns.prices = ns.prices + [state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float] %}
              {% endif %}
            {% endfor %}
            {{ ns.prices | min | float if ns.prices | length >= 23 else 0 }}
          {% else %}
            {{ 0 }}
          {% endif %}
        attributes:
          Hour: >
            {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
              {% set timeStampList = state_attr("sensor.porssari_json_data", "Prices") | list %}
              {% set ns = namespace(ts=[], prices=[], hours=[]) %}
              {% for item in timeStampList %}
                {% if now().day == as_datetime(item).day %}
                  {% set ns.ts = ns.ts + [item] %}
                  {% set ns.prices = ns.prices + [state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float] %}
                {% endif %}
              {% endfor %}
              {% set pmin = ns.prices | min | float %}
              {% for item in ns.ts %}
                {% if state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float == pmin %}
                  {% set ns.hours = ns.hours + [as_datetime(item).hour | int] %}
                {% endif %}
              {% endfor %}
              {{ ns.hours }}
            {% else %}
              {{ 0 }}
            {% endif %}
      - name: porssari_max_today
        unit_of_measurement: "snt/kWh"
        device_class: monetary
        state: >
          {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
            {% set timeStampList = state_attr("sensor.porssari_json_data", "Prices") | list %}
            {% set ns = namespace(prices=[]) %}
            {% for item in timeStampList %}
              {% if now().day == as_datetime(item).day %}
                {% set ns.prices = ns.prices + [state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float] %}
              {% endif %}
            {% endfor %}
            {{ ns.prices | max | float if ns.prices | length >= 23 else 0 }}
          {% else %}
            {{ 0 }}
          {% endif %}
        attributes:
          Hour: >
            {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
              {% set timeStampList = state_attr("sensor.porssari_json_data", "Prices") | list %}
              {% set ns = namespace(ts=[], prices=[], hours=[]) %}
              {% for item in timeStampList %}
                {% if now().day == as_datetime(item).day %}
                  {% set ns.ts = ns.ts + [item] %}
                  {% set ns.prices = ns.prices + [state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float] %}
                {% endif %}
              {% endfor %}
              {% set pmin = ns.prices | max | float %}
              {% for item in ns.ts %}
                {% if state_attr("sensor.porssari_json_data", "Prices")[item]['Price'] | float == pmin %}
                  {% set ns.hours = ns.hours + [as_datetime(item).hour | int] %}
                {% endif %}
              {% endfor %}
              {{ ns.hours }}
            {% else %}
              {{ 0 }}
            {% endif %}
  
  # Add your own sensors after this line