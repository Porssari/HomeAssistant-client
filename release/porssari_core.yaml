##################################
# Pörssäri Home Assistant client #
##################################

# This file includes core functionalities. Do not edit this file.
# Add "Pörssäri laitetunnus" via Settings --> Devices & Services --> Helpers

# JSON-request from server
rest:
  - resource_template: >
      {% set MAC = states('input_text.porssari_mac') if states('input_text.porssari_mac') | length > 10 else "HA_undefined" %} 
      {% if state_attr("sensor.porssari_json_data", "metadata") %}
        {% set timestamp = state_attr("sensor.porssari_json_data", "metadata")['timestamp'] %}
        {% set fetch_url = state_attr("sensor.porssari_json_data", "metadata")['fetch_url'] %}
      {% else %}
        {% set timestamp = 0 %}
        {% set fetch_url = "https://api.porssari.fi/getcontrols.php" %}
      {% endif %}
      {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_2.0-rc1&json_version=2
    scan_interval: 604800
    sensor:
      - name: "porssari_json"
        value_template: "{{ value_json.metadata.timestamp|default(0) }}"
        json_attributes:
          - metadata
          - controls

# Is updated -state request from server
command_line:
  - sensor:
      name: "porssari_request"
      command: >-
        curl -o /dev/null -qsI -w "%{http_code}\n" "
        {%- set MAC = states("input_text.porssari_mac")|default("HA_undefined") -%}
        {%- set timestamp = state_attr("sensor.porssari_json_data", "metadata")["timestamp"]|default("0") -%}
        {%- set fetch_url = state_attr("sensor.porssari_json_data", "metadata")["fetch_url"]|default("https://api.porssari.fi/getcontrols.php") -%}
        {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_2.0-rc1&headers=true"
      scan_interval: 300
      value_template: "{{ value }}"

template:
  # Sensors for Channel states.
  - sensor:
      - name: "porssari_channel_1_state"
        unique_id: porssari_ch1_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[0]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[0]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 2 State"
        unique_id: porssari_ch2_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[1]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[1]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 3 State"
        unique_id: porssari_ch3_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[2]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[2]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 4 State"
        unique_id: porssari_ch4_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[3]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[3]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 5 State"
        unique_id: porssari_ch5_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[4]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[4]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 6 State"
        unique_id: porssari_ch6_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[5]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[5]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 7 State"
        unique_id: porssari_ch7_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[6]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[6]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 8 State"
        unique_id: porssari_ch8_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data", "controls")[7]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data", "controls")[7]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}

  # Sensor to save request json data.
  - sensor:
      - name: porssari_json_data
        state: >
          {% if state_attr("sensor.porssari_json_data", "metadata") %}
            {{ state_attr("sensor.porssari_json_data", "metadata")['timestamp'] }}
          {% else %}
            {{ 0 }}
          {% endif %}
        attributes:
          metadata: >
            {{ state_attr("sensor.porssari_json", "metadata") if state_attr("sensor.porssari_json", "metadata") else state_attr("sensor.porssari_json_data", "metadata") }}
          controls: >
            {{ state_attr("sensor.porssari_json", "controls") if state_attr("sensor.porssari_json", "controls") else state_attr("sensor.porssari_json_data", "controls") }}

  # Sensor to determine if json is valid for controls
  - binary_sensor:
      - name: porssari_json_controls
        state: >
          {% if state_attr("sensor.porssari_json_data", "metadata") %}
            {% set validUntil = as_datetime(state_attr("sensor.porssari_json_data", "metadata")['valid_until'] | int).timestamp() %}
            {% set timestampNow = utcnow().timestamp() %}
            {{ timestampNow < validUntil }}
          {% else %}
            {{ false }}
          {% endif %}

# Update logic for json-sensor.
automation:
  - id: "porssari_update_automation"
    alias: Pörssäri-ohjaustiedon päivitys
    description: "Uusi ohjaustieto haetaan kun asetuksia on päivitetty tai tunnin välein"
    trigger:
      - platform: time_pattern
        hours: /4
      - platform: state
        entity_id:
          - sensor.porssari_request
      - platform: homeassistant
        event: start
    condition:
      - condition: template
        value_template: '{{ is_state("sensor.porssari_request", "200") }}'
        alias: Päivitä vain kun serveri tarjoaa uutta jsonia
    action:
      - delay: 15
      - service: homeassistant.update_entity
        alias: Päivitä porssari_json
        target:
          entity_id: sensor.porssari_json

# Settings parameters
input_text:
  porssari_mac:
    name: Pörssäri laitetunnus
