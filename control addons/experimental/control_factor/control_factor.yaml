# Control factor based on relative difference of current price from daily max price
# Original functionality based on spotprices2ha delevoped by Temez

template:
  - sensor:
      - name: porssari_control_factor
        unit_of_measurement: factor
        icon: mdi:gauge
        state: >
          {% if is_state('binary_sensor.porssari_json_prices', 'on') %}
            {% set ns = namespace(factor=[]) %}
            {% set pnow = states("sensor.porssari_price_now") | float %}
            {% set pmin = states("sensor.porssari_min_today") | float %}
            {% set pmax = states("sensor.porssari_max_today") | float %}
            {% set val = max(min((2*(pmax - pnow) / (pmax - pmin)-1) * states('input_number.porssari_control_function_factor') | float,1),-1) %}
            {% if states("input_select.porssari_control_function" ) == "Linear" %}
              {% set ns.factor = val | round(2) %}
            {% else %}
              {% set ns.factor = sin(val*pi/2) | round(2) %}
            {% endif %}
            {% if states("input_select.porssari_control_function_output" ) == "-1 - 1" %}
              {{ ns.factor }}
            {% else %}
              {{ ns.factor | float /2 + 0.5 }}
            {% endif %}
          {% else %}
            {{ 0 }}
          {% endif %}

# Settings parameters
input_number:
  porssari_control_function_factor:
    min: 1
    max: 3
    step: 0.01
    icon: mdi:gauge
    mode: box

input_select:
  porssari_control_function:
    options:
      - Linear
      - Sinusoidal
    icon: mdi:gauge
  porssari_control_function_output:
    options:
      - "0 - 1"
      - "-1 - 1"
    icon: mdi:gauge