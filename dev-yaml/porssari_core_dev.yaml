##################################
# Pörssäri Home Assistant client #
# DEVELOPMENT VERSION            #
##################################

# This file includes core functionalities. Do not edit this file.
# Sensors based on Pörssari json data are included in porssari_sensors.yaml

# JSON-request from server
rest:
  - resource_template: >
      {% set MAC = states('input_text.porssari_mac_dev') if states('input_text.porssari_mac_dev') | length > 10 else "HA_undefined" %} 
      {% if state_attr("sensor.porssari_json_data_dev", "Metadata") %}
        {% set timestamp = state_attr("sensor.porssari_json_data_dev", "Metadata")['Timestamp'] %}
        {% set fetch_url = state_attr("sensor.porssari_json_data_dev", "Metadata")['Fetch_url'] %}
      {% else %}
        {% set timestamp = 0 %}
        {% set fetch_url = "https://dev.porssari.fi/getcontrols.php" %}
      {% endif %}
      {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_1.0-dev&prices=true
    scan_interval: 604800
    sensor:
      - name: "porssari_json_dev"
        value_template: "{{ value_json.Metadata.Timestamp|default(0) }}"
        json_attributes:
          - Metadata
          - Prices
          - Channel1
          - Channel2
          - Channel3
          - Channel4
          - Channel5
          - Channel6
          - Channel7
          - Channel8

# Is updated -state request from server
command_line:
  - sensor:
      name: "porssari_request_dev"
      command: >-
        curl -o /dev/null -qsI -w "%{http_code}\n" "
        {%- set MAC = states("input_text.porssari_mac_dev")|default("HA_undefined") -%}
        {%- set timestamp = state_attr("sensor.porssari_json_data_dev", "Metadata")["Timestamp"]|default("0") -%}
        {%- set fetch_url = state_attr("sensor.porssari_json_data_dev", "Metadata")["Fetch_url"]|default("https://dev.porssari.fi/getcontrols.php") -%}
        {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_1.0-dev"
      scan_interval: 120
      value_template: "{{ value }}"

template:
  # Sensors for Channel states.
  - sensor:
      - name: "Pörssäri Dev Channel 1 State"
        unique_id: porssari_dev_ch1_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel1")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 2 State"
        unique_id: porssari_dev_ch2_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel2")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 3 State"
        unique_id: porssari_dev_ch3_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel3")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 4 State"
        unique_id: porssari_dev_ch4_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel4")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 5 State"
        unique_id: porssari_dev_ch5_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel5")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 6 State"
        unique_id: porssari_dev_ch6_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel6")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 7 State"
        unique_id: porssari_dev_ch7_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel7")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Dev Channel 8 State"
        unique_id: porssari_dev_ch8_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set curHour = now().hour | string %}
            {{ state_attr("sensor.porssari_json_data_dev", "Channel8")[curHour] }}
          {% else %}
            {{ -1 }}
          {% endif %}

  # Sensor to save request json data.
  - sensor:
      - name: porssari_json_data_dev
        state: >
          {% if state_attr("sensor.porssari_json_data_dev", "Metadata") %}
            {{ state_attr("sensor.porssari_json_data_dev", "Metadata")['Timestamp'] }}
          {% else %}
            {{ 0 }}
          {% endif %}
        attributes:
          Metadata: >
            {{ state_attr("sensor.porssari_json_dev", "Metadata") if state_attr("sensor.porssari_json_dev", "Metadata") else state_attr("sensor.porssari_json_data_dev", "Metadata") }}
          Prices: >
            {{ state_attr("sensor.porssari_json_dev", "Prices") if state_attr("sensor.porssari_json_dev", "Prices") else state_attr("sensor.porssari_json_data_dev", "Prices") }}
          Channel1: >
            {{ state_attr("sensor.porssari_json_dev", "Channel1") if state_attr("sensor.porssari_json_dev", "Channel1") else state_attr("sensor.porssari_json_data_dev", "Channel1") }}
          Channel2: >
            {{ state_attr("sensor.porssari_json_dev", "Channel2") if state_attr("sensor.porssari_json_dev", "Channel2") else state_attr("sensor.porssari_json_data_dev", "Channel2") }}
          Channel3: >
            {{ state_attr("sensor.porssari_json_dev", "Channel3") if state_attr("sensor.porssari_json_dev", "Channel3") else state_attr("sensor.porssari_json_data_dev", "Channel3") }}
          Channel4: >
            {{ state_attr("sensor.porssari_json_dev", "Channel4") if state_attr("sensor.porssari_json_dev", "Channel4") else state_attr("sensor.porssari_json_data_dev", "Channel4") }}
          Channel5: >
            {{ state_attr("sensor.porssari_json_dev", "Channel5") if state_attr("sensor.porssari_json_dev", "Channel5") else state_attr("sensor.porssari_json_data_dev", "Channel5") }}
          Channel6: >
            {{ state_attr("sensor.porssari_json_dev", "Channel6") if state_attr("sensor.porssari_json_dev", "Channel6") else state_attr("sensor.porssari_json_data_dev", "Channel6") }}
          Channel7: >
            {{ state_attr("sensor.porssari_json_dev", "Channel7") if state_attr("sensor.porssari_json_dev", "Channel7") else state_attr("sensor.porssari_json_data_dev", "Channel7") }}
          Channel8: >
            {{ state_attr("sensor.porssari_json_dev", "Channel8") if state_attr("sensor.porssari_json_dev", "Channel8") else state_attr("sensor.porssari_json_data_dev", "Channel8") }}

  # Sensor to determine if json is valid for controls and contains price data
  - binary_sensor:
      - name: porssari_json_controls_dev
        state: >
          {% if state_attr("sensor.porssari_json_data_dev", "Metadata") %}
            {% set timestamp = as_datetime(state_attr("sensor.porssari_json_data_dev", "Metadata")['Timestamp'] | int).strftime('%Y-%m-%dT%H:00:00%z') %}
            {% set fromJson = utcnow().timestamp() - as_datetime(timestamp).timestamp() %}
            {% set hoursCount = state_attr("sensor.porssari_json_data_dev", "Metadata")['Hours_count'] %}
            {% set maxDiff = hoursCount * 3600 %}
            {{ maxDiff - fromJson > 0 }}
          {% else %}
            {{ false }}
          {% endif %}
      - name: porssari_json_prices_dev
        state: >
          {% set ns = namespace(pricesToday=[]) %}
          {% if state_attr("sensor.porssari_json_data_dev", "Prices") %}
            {% set timeStampList = state_attr("sensor.porssari_json_data_dev", "Prices") | list %}
            {% for item in timeStampList %}
              {% if now().day == as_datetime(item).day %}
                {% set ns.pricesToday = ns.pricesToday + [state_attr("sensor.porssari_json_data_dev", "Prices")[item]['Price'] | float] %}
              {% endif %}            
            {% endfor %}
          {% endif %}
          {{ ns.pricesToday | length >= 23 }}

# Update logic for json-sensor.
automation:
  - id: "porssari_dev_update_automation"
    alias: Pörssäri-dev -ohjaustiedon päivitys
    description: "Uusi ohjaustieto haetaan kun asetuksia on päivitetty tai tunnin välein"
    trigger:
      - platform: time_pattern
        hours: /1
      - platform: state
        entity_id:
          - sensor.porssari_request_dev
      - platform: homeassistant
        event: start
    condition:
      - condition: template
        value_template: '{{ is_state("sensor.porssari_request_dev", "200") }}'
        alias: Päivitä vain kun serveri tarjoaa uutta jsonia
    action:
      - delay: 15
      - service: homeassistant.update_entity
        alias: Päivitä porssari_json_dev
        target:
          entity_id: sensor.porssari_json_dev

# Settings parameters
input_text:
  porssari_mac_dev:
    name: Pörssäri laitetunnus