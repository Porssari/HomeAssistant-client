########################################################
# Pörssäri Home Assistant client - DEVELOPMENT VERSION #
#                                                      #
# Do not use this file if you don't have access to     #
# development features in Pörssäri service             #
########################################################

# This file includes core functionalities. Do not edit this file.
# Sensors based on Pörssari json data are included in porssari_sensors.yaml

# JSON-request from server
rest:
  - resource_template: >
      {% set MAC = states('input_text.porssari_mac_dev') if states('input_text.porssari_mac_dev') | length > 10 else "HA_undefined" %} 
      {% if state_attr("sensor.porssari_json_data_dev", "metadata") %}
        {% set timestamp = state_attr("sensor.porssari_json_data_dev", "metadata")['timestamp'] %}
        {% set fetch_url = state_attr("sensor.porssari_json_data_dev", "metadata")['fetch_url'] %}
      {% else %}
        {% set timestamp = 0 %}
        {% set fetch_url = "https://dev.porssari.fi/getcontrols.php" %}
      {% endif %}
      {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_2.0-dev&json_version=2&prices=true
    scan_interval: 604800
    sensor:
      - name: "porssari_json_dev"
        value_template: "{{ value_json.metadata.timestamp|default(0) }}"
        json_attributes:
          - metadata
          - controls
          - prices

# Is updated -state request from server
command_line:
  - sensor:
      name: "porssari_request_dev"
      command: >-
        curl -o /dev/null -qsI -w "%{http_code}\n" "
        {%- set MAC = states("input_text.porssari_mac_dev")|default("HA_undefined") -%}
        {%- set timestamp = state_attr("sensor.porssari_json_data_dev", "metadata")["timestamp"]|default("0") -%}
        {%- set fetch_url = state_attr("sensor.porssari_json_data_dev", "metadata")["fetch_url"]|default("https://dev.porssari.fi/getcontrols.php") -%}
        {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_2.0-dev&headers=true"
      scan_interval: 604800
      value_template: "{{ value }}"

template:
  # Sensors for Channel states.
  - sensor:
      - name: "porssari_dev_channel_1_state"
        unique_id: porssari_dev_ch1_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[0]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[0]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_2_state"
        unique_id: porssari_dev_ch2_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[1]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[1]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_3_state"
        unique_id: porssari_dev_ch3_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[2]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[2]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_4_state"
        unique_id: porssari_dev_ch4_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[3]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[3]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_5_state"
        unique_id: porssari_dev_ch5_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[4]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[4]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_6_state"
        unique_id: porssari_dev_ch6_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[5]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[5]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_7_state"
        unique_id: porssari_dev_ch7_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[6]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[6]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "porssari_dev_channel_8_state"
        unique_id: porssari_dev_ch8_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls_dev', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% set ns.state = state_attr("sensor.porssari_json_data_dev", "controls")[7]["state"] %}
            {% for item in state_attr("sensor.porssari_json_data_dev", "controls")[7]["schedules"] %}
              {% if as_datetime(item.timestamp) < now() %}
                {% set ns.state = item.state %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}

  # Sensor to save request json data.
  - sensor:
      - name: porssari_json_data_dev
        state: >
          {% if state_attr("sensor.porssari_json_data_dev", "metadata") %}
            {{ state_attr("sensor.porssari_json_data_dev", "metadata")['timestamp'] }}
          {% else %}
            {{ 0 }}
          {% endif %}
        attributes:
          metadata: >
            {{ state_attr("sensor.porssari_json_dev", "metadata") if state_attr("sensor.porssari_json_dev", "metadata") else state_attr("sensor.porssari_json_data_dev", "metadata") }}
          controls: >
            {{ state_attr("sensor.porssari_json_dev", "controls") if state_attr("sensor.porssari_json_dev", "controls") else state_attr("sensor.porssari_json_data_dev", "controls") }}
          prices: >
            {{ state_attr("sensor.porssari_json_dev", "prices") if state_attr("sensor.porssari_json_dev", "controls") else state_attr("sensor.porssari_json_data_dev", "controls") }}

  # Sensor to determine if json is valid for controls
  - binary_sensor:
      - name: porssari_json_controls_dev
        state: >
          {% if state_attr("sensor.porssari_json_data_dev", "metadata") %}
            {% set validUntil = as_datetime(state_attr("sensor.porssari_json_data_dev", "metadata")['valid_until'] | int).timestamp() %}
            {% set timestampNow = utcnow().timestamp() %}
            {{ timestampNow < validUntil }}
          {% else %}
            {{ false }}
          {% endif %}

      - name: porssari_json_prices_dev
        state: >
          {% set ns = namespace(pricesToday=[]) %}
          {% if state_attr("sensor.porssari_json_data_dev", "prices") %}
            {% set timeStampList = state_attr("sensor.porssari_json_data_dev", "prices") | list %}
            {% for item in timeStampList %}
              {% if now().day == as_datetime(item).day %}
                {% set ns.pricesToday = ns.pricesToday + [state_attr("sensor.porssari_json_data_dev", "prices")[item]['price'] | float] %}
              {% endif %}            
            {% endfor %}
          {% endif %}
          {{ ns.pricesToday | length >= 23 }}

# Update logic for json-sensor.
automation:
  - id: "porssari_dev_update_automation"
    alias: porssari_dev_update_json
    description: "Uusi ohjaustieto haetaan kun asetuksia on päivitetty tai tunnin välein"
    trigger:
      - platform: time_pattern
        minutes: /5
      - platform: homeassistant
        event: start
    action:
      - delay: "{{ range(30) | random }}"
      - service: homeassistant.update_entity
        alias: update_porssari_request_dev
        target:
          entity_id: sensor.porssari_request_dev
      - if:
          - condition: state
            entity_id: sensor.porssari_request_dev
            state: "200"
        then:
          - delay: 12
          - service: homeassistant.update_entity
            alias: update_porssari_json_dev
            target:
              entity_id: sensor.porssari_json_dev
    mode: single

# Settings parameters
input_text:
  porssari_mac_dev:
    name: Pörssäri laitetunnus
